{% extends "deals_page.html" %}

{% block content %}
<h2>–ê–∫—Ç–∏–≤–Ω—ã–µ —Å–¥–µ–ª–∫–∏</h2>
<div id="table-container"></div>

{{ recent_active|json_script:"recent-deals-data" }}

<script>
    const dealsData = JSON.parse(
        document.getElementById('recent-deals-data').textContent
    );

    // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã
    const container = document.getElementById('table-container');

    if (dealsData.length === 0) {
        container.innerHTML = '<div class="empty-state">üìã –ê–∫—Ç–∏–≤–Ω—ã—Ö —Å–¥–µ–ª–æ–∫ –ø–æ–∫–∞ –Ω–µ—Ç</div>';
    } else {
        const table = document.createElement('table');
        table.className = 'deals-table';

        const thead = document.createElement('thead');
        const headerRow = document.createElement('tr');

        const headers = ['ID', '–ù–∞–∑–≤–∞–Ω–∏–µ', '–≠—Ç–∞–ø', '–°—É–º–º–∞', '–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞', '–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è', '–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏'];

        headers.forEach(headerText => {
            const th = document.createElement('th');
            th.textContent = headerText;
            headerRow.appendChild(th);
        });

        thead.appendChild(headerRow);
        table.appendChild(thead);

        const tbody = document.createElement('tbody');

        dealsData.forEach((deal, index) => {
            const row = document.createElement('tr');
            row.className = index % 2 === 0 ? 'even' : 'odd';

            let opportunityValue = '‚Äî';
            if (deal.OPPORTUNITY !== undefined && deal.OPPORTUNITY !== null) {
                if (typeof deal.OPPORTUNITY === 'number') {
                    opportunityValue = deal.OPPORTUNITY.toLocaleString('ru-RU', {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2
                    }) + ' ‚ÇΩ';
                } else {
                    opportunityValue = deal.OPPORTUNITY;
                }
            }

            // –î–æ–±–∞–≤–ª—è–µ–º –∏–∫–æ–Ω–∫–∏ –¥–ª—è —Å—Ç–∞—Ç—É—Å–æ–≤
            let stageText = deal.STAGE_NAME || deal.STAGE_ID;
            switch(deal.STAGE_ID) {
                case 'NEW':
                    stageText = 'üÜï ' + stageText;
                    break;
                case 'PREPARATION':
                    stageText = '‚öôÔ∏è ' + stageText;
                    break;
                case 'EXECUTING':
                    stageText = 'üîÑ ' + stageText;
                    break;
                case 'FINAL_INVOICE':
                    stageText = 'üí∞ ' + stageText;
                    break;
                case 'WON':
                    stageText = '‚úÖ ' + stageText;
                    break;
                case 'LOSE':
                    stageText = '‚ùå ' + stageText;
                    break;
            }

            const cells = [
                deal.ID,
                deal.TITLE,
                stageText,
                opportunityValue,
                deal.BEGINDATE,
                deal.CLOSEDATE || '‚Äî',
                deal.ADDRESS || '‚Äî'
            ];

            cells.forEach((cellData, cellIndex) => {
                const td = document.createElement('td');
                td.textContent = cellData !== undefined && cellData !== null ? cellData : '‚Äî';

                // –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã—Ö –∫–æ–ª–æ–Ω–æ–∫
                if (cellIndex === 3) { // –°—É–º–º–∞
                    td.className = 'amount';
                }
                if (cellIndex === 2) { // –≠—Ç–∞–ø
                    td.className = 'stage';
                }

                row.appendChild(td);
            });

            tbody.appendChild(row);
        });

        table.appendChild(tbody);
        container.appendChild(table);
    }
</script>

<style>
/* –°—Ç–∏–ª–∏ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã —Å–¥–µ–ª–æ–∫ */
.deals-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 1rem;
    background: var(--background-color, #ffffff);
    border-radius: var(--border-radius, 8px);
    overflow: hidden;
    box-shadow: var(--shadow, 0 2px 10px rgba(0, 0, 0, 0.1));
}

.deals-table thead {
    background: var(--primary-color, #2c3e50);
    color: white;
}

.deals-table th,
.deals-table td {
    padding: 1rem 0.75rem;
    text-align: left;
    border-bottom: 1px solid var(--border-color, #dee2e6);
}

.deals-table th {
    font-weight: 600;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.deals-table tbody tr:hover {
    background: var(--background-light, #f8f9fa);
    transition: var(--transition, all 0.3s ease);
}

.deals-table tbody tr.even {
    background: rgba(248, 249, 250, 0.5);
}

.deals-table td.amount {
    text-align: right;
    font-weight: 600;
    color: var(--success-color, #27ae60);
}

.deals-table td.stage {
    font-weight: 500;
}

/* –ü—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ */
.empty-state {
    text-align: center;
    padding: 3rem 2rem;
    color: var(--text-light, #7f8c8d);
    font-size: 1.2rem;
    background: var(--background-light, #f8f9fa);
    border-radius: var(--border-radius, 8px);
    border: 2px dashed var(--border-color, #dee2e6);
}

/* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å —Ç–∞–±–ª–∏—Ü—ã */
@media (max-width: 1024px) {
    .deals-table {
        font-size: 0.9rem;
    }

    .deals-table th,
    .deals-table td {
        padding: 0.75rem 0.5rem;
    }
}

@media (max-width: 768px) {
    .deals-table {
        font-size: 0.8rem;
    }

    .deals-table th,
    .deals-table td {
        padding: 0.5rem 0.3rem;
    }

    /* –°–∫—Ä—ã–≤–∞–µ–º –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –∫–æ–ª–æ–Ω–∫–∏ –Ω–∞ –º–æ–±–∏–ª—å–Ω–æ–º */
    .deals-table th:nth-child(7),
    .deals-table td:nth-child(7),
    .deals-table th:nth-child(6),
    .deals-table td:nth-child(6) {
        display: none;
    }
}

@media (max-width: 480px) {
    /* –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –≤–∏–¥ –¥–ª—è –æ—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–æ–≤ */
    .deals-table,
    .deals-table thead,
    .deals-table tbody,
    .deals-table th,
    .deals-table td,
    .deals-table tr {
        display: block;
    }

    .deals-table thead tr {
        position: absolute;
        top: -9999px;
        left: -9999px;
    }

    .deals-table tr {
        background: var(--background-color, #ffffff);
        border: 1px solid var(--border-color, #dee2e6);
        border-radius: var(--border-radius, 8px);
        margin-bottom: 1rem;
        padding: 1rem;
        box-shadow: var(--shadow, 0 2px 10px rgba(0, 0, 0, 0.1));
    }

    .deals-table td {
        border: none;
        position: relative;
        padding: 0.5rem 0;
        padding-left: 30%;
        text-align: right;
    }

    .deals-table td:before {
        content: attr(data-label);
        position: absolute;
        left: 0;
        width: 25%;
        padding-right: 10px;
        white-space: nowrap;
        font-weight: 600;
        text-align: left;
        color: var(--primary-color, #2c3e50);
    }

    /* –î–æ–±–∞–≤–ª—è–µ–º –ª–µ–π–±–ª—ã —á–µ—Ä–µ–∑ JavaScript –±—É–¥–µ—Ç –ø—Ä–æ—â–µ */
}

/* –ê–Ω–∏–º–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ */
#table-container:empty::after {
    content: "–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...";
    display: block;
    text-align: center;
    padding: 2rem;
    color: var(--text-light, #7f8c8d);
    font-style: italic;
}
</style>

{% endblock %}