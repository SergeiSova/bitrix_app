{% extends "product_page.html" %}

{% block content %}
  <h2>–î–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤–≤–µ–¥–∏—Ç–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é</h2>

  <!-- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ—à–∏–±–æ–∫ -->
  {% if error_message %}
    <div style="
      background-color: #f8d7da;
      border: 1px solid #f1aeb5;
      color: #721c24;
      padding: 15px;
      border-radius: 5px;
      margin: 20px 0;
      font-weight: bold;
    ">
      ‚ùå –û—à–∏–±–∫–∞: {{ error_message }}
    </div>
  {% endif %}

  <!-- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ -->
  {% if qr_base64 and not error_message %}
    <div style="
      background-color: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
      padding: 15px;
      border-radius: 5px;
      margin: 20px 0;
    ">
      ‚úÖ QR-–∫–æ–¥ —É—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω!
    </div>
  {% endif %}

  <form method="post" action="{% url 'qr_generator' %}">
    {% csrf_token %}
    <table>
      <tr>
        <td>
          <label for="product_id">ID —Ç–æ–≤–∞—Ä–∞:</label><br>
          <input
            type="number"
            step="1"
            min="1"
            name="product_id"
            id="product_id"
            placeholder="–í–≤–µ–¥–∏—Ç–µ ID"
            value="{{ form_data.product_id|default:'' }}">
        </td>
        <td style="text-align: center; vertical-align: middle; padding: 0 30px;">
          –∏–ª–∏
        </td>
        <td style="position: relative;">
          <label for="product_name">–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞:</label><br>
          <input
            type="text"
            name="product_name"
            id="product_name"
            placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ"
            style="width: 230px;"
            value="{{ form_data.product_name|default:'' }}">
          <ul id="autocomplete_results" hidden style="
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ccc;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            margin: 0;
            padding: 0;
            list-style: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
          "></ul>
        </td>
      </tr>
    </table>

    <div style="margin-top: 20px;">
      <button type="submit" style="
        padding: 10px 30px;
        width: 500px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 5px;
        font-size: 16px;
        cursor: pointer;
      ">
        –°–æ–∑–¥–∞—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É
      </button>
    </div>
  </form>

  <script>
    const nameInput = document.getElementById("product_name");
    const idInput = document.getElementById("product_id");
    const resultsContainer = document.getElementById("autocomplete_results");

    let timeoutId;

    nameInput.addEventListener("input", () => {
      clearTimeout(timeoutId);
      const query = nameInput.value.trim();

      if (query.length === 0) {
        resultsContainer.hidden = true;
        return;
      }

      timeoutId = setTimeout(() => {
        fetch(`/product/autocomplete/?q=${encodeURIComponent(query)}`)
          .then(response => {
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
          })
          .then(data => {
            resultsContainer.innerHTML = "";

            if (!data.results || data.results.length === 0) {
              resultsContainer.hidden = true;
              return;
            }

            data.results.forEach(item => {
              const li = document.createElement("li");
              li.textContent = item.name;
              li.dataset.id = item.id;

              // –°—Ç–∏–ª–∏ –¥–ª—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —Å–ø–∏—Å–∫–∞
              li.style.padding = "8px 12px";
              li.style.cursor = "pointer";
              li.style.borderBottom = "1px solid #eee";
              li.style.backgroundColor = "#fff";

              li.addEventListener("mouseenter", () => {
                li.style.backgroundColor = "#f8f9fa";
              });

              li.addEventListener("mouseleave", () => {
                li.style.backgroundColor = "#fff";
              });

              li.addEventListener("click", () => {
                nameInput.value = item.name;
                idInput.value = item.id;
                resultsContainer.hidden = true;
              });

              resultsContainer.appendChild(li);
            });

            resultsContainer.hidden = false;
          })
          .catch(error => {
            console.error("Autocomplete error:", error);
            resultsContainer.hidden = true;
          });
      }, 300);
    });

    // –°–∫—Ä—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
    document.addEventListener("click", (event) => {
      if (!nameInput.contains(event.target) && !resultsContainer.contains(event.target)) {
        resultsContainer.hidden = true;
      }
    });

    // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ ID –ø—Ä–∏ –≤–≤–æ–¥–µ –Ω–∞–∑–≤–∞–Ω–∏—è
    nameInput.addEventListener("input", () => {
      if (nameInput.value.trim()) {
        idInput.value = "";
      }
    });

    // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –Ω–∞–∑–≤–∞–Ω–∏—è –ø—Ä–∏ –≤–≤–æ–¥–µ ID
    idInput.addEventListener("input", () => {
      if (idInput.value.trim()) {
        nameInput.value = "";
        resultsContainer.hidden = true;
      }
    });
  </script>

  <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR-–∫–æ–¥–∞ -->
  {% if qr_base64 and not error_message %}
    <div style="
      margin-top: 30px;
      padding: 20px;
      border: 2px solid #28a745;
      border-radius: 10px;
      background-color: #f8fff9;
      text-align: center;
    ">
      <h3 style="color: #28a745; margin-top: 0;">
        üéâ QR-–∫–æ–¥ –≥–æ—Ç–æ–≤! (ID —Ç–æ–≤–∞—Ä–∞: {{ product_id }})
      </h3>

      <div style="margin: 20px 0;">
        <img src="data:image/png;base64,{{ qr_base64 }}"
             alt="QR Code"
             style="border: 1px solid #ddd; border-radius: 5px;">
      </div>

      <div style="margin-top: 15px;">
        <p style="margin: 5px 0;">
          <strong>–°—Å—ã–ª–∫–∞ –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫—É —Ç–æ–≤–∞—Ä–∞:</strong>
        </p>
        <a href="{{ gen_url }}"
           target="_blank"
           style="
             color: #007bff;
             text-decoration: none;
             word-break: break-all;
             font-size: 14px;
           ">
          {{ gen_url }}
        </a>
      </div>

      <div style="margin-top: 20px;">
        <button onclick="window.print()" style="
          padding: 8px 16px;
          background-color: #17a2b8;
          color: white;
          border: none;
          border-radius: 3px;
          cursor: pointer;
          margin-right: 10px;
        ">
          üñ®Ô∏è –ü–µ—á–∞—Ç—å QR-–∫–æ–¥–∞
        </button>

        <button onclick="copyToClipboard('{{ gen_url }}')" style="
          padding: 8px 16px;
          background-color: #6c757d;
          color: white;
          border: none;
          border-radius: 3px;
          cursor: pointer;
        ">
          üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É
        </button>
      </div>
    </div>

    <script>
      function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(function() {
          alert('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
        }, function(err) {
          console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è: ', err);
          // Fallback –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤
          const textArea = document.createElement("textarea");
          textArea.value = text;
          document.body.appendChild(textArea);
          textArea.select();
          try {
            document.execCommand('copy');
            alert('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
          } catch (err) {
            alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É');
          }
          document.body.removeChild(textArea);
        });
      }
    </script>
  {% endif %}

{% endblock %}