{% extends "product_page.html" %}

{% block content %}
  <h2>–ì–µ–Ω–µ—Ä–∞—Ü–∏—è QR-–∫–æ–¥–∞ –¥–ª—è —Ç–æ–≤–∞—Ä–∞</h2>

  <!-- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ—à–∏–±–æ–∫ -->
  {% if error_message %}
    <div style="
      background-color: #f8d7da;
      border: 1px solid #f1aeb5;
      color: #721c24;
      padding: 15px;
      border-radius: 5px;
      margin: 20px 0;
      font-weight: bold;
    ">
      ‚ùå –û—à–∏–±–∫–∞: {{ error_message }}
    </div>
  {% endif %}

  <!-- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ -->
  {% if qr_base64 and not error_message %}
    <div style="
      background-color: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
      padding: 15px;
      border-radius: 5px;
      margin: 20px 0;
    ">
      ‚úÖ QR-–∫–æ–¥ –¥–ª—è —Ç–æ–≤–∞—Ä–∞ "{{ product_name }}" —É—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω!
    </div>
  {% endif %}

  <!-- –§–æ—Ä–º–∞ –ø–æ–∏—Å–∫–∞ —Ç–æ–≤–∞—Ä–∞ -->
  <form method="post" action="{% url 'qr_generator' %}">
    {% csrf_token %}

    <div style="margin-bottom: 20px;">
      <label for="product_name" style="
        display: block;
        font-weight: bold;
        margin-bottom: 8px;
        font-size: 16px;
      ">
        –ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞:
      </label>

      <div style="position: relative; display: inline-block;">
        <input
          type="text"
          name="product_name"
          id="product_name"
          placeholder="–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞..."
          style="
            width: 400px;
            padding: 12px;
            font-size: 16px;
            border: 2px solid #ced4da;
            border-radius: 5px;
            box-sizing: border-box;
          "
          value="{{ form_data.product_name|default:'' }}"
          autocomplete="off"
          required>

        <!-- –°–ø–∏—Å–æ–∫ –∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è -->
        <ul id="autocomplete_results" hidden style="
          position: absolute;
          top: 100%;
          left: 0;
          right: 0;
          background: white;
          border: 1px solid #ccc;
          border-top: none;
          max-height: 200px;
          overflow-y: auto;
          z-index: 1000;
          margin: 0;
          padding: 0;
          list-style: none;
          box-shadow: 0 2px 8px rgba(0,0,0,0.15);
          border-radius: 0 0 5px 5px;
        "></ul>
      </div>


    </div>

    <div style="margin-top: 25px;">
      <button type="submit" style="
        padding: 15px 40px;
        font-size: 18px;
        font-weight: bold;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: background-color 0.3s;
      " onmouseover="this.style.backgroundColor='#0056b3'"
         onmouseout="this.style.backgroundColor='#007bff'">
        üéØ –°–æ–∑–¥–∞—Ç—å QR-–∫–æ–¥
      </button>
    </div>
  </form>

  <script>
    const nameInput = document.getElementById("product_name");
    const resultsContainer = document.getElementById("autocomplete_results");

    let timeoutId;

    nameInput.addEventListener("input", () => {
      clearTimeout(timeoutId);
      const query = nameInput.value.trim();

      if (query.length < 2) {
        resultsContainer.hidden = true;
        return;
      }

      timeoutId = setTimeout(() => {
        fetch(`/product/autocomplete/?q=${encodeURIComponent(query)}`)
          .then(response => {
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
          })
          .then(data => {
            resultsContainer.innerHTML = "";

            if (!data.results || data.results.length === 0) {
              const li = document.createElement("li");
              li.textContent = "–¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã";
              li.style.padding = "8px 12px";
              li.style.color = "#999";
              li.style.fontStyle = "italic";
              resultsContainer.appendChild(li);
              resultsContainer.hidden = false;
              return;
            }

            data.results.forEach(item => {
              const li = document.createElement("li");
              li.innerHTML = `<strong>${item.name}</strong> <span style="color: #666; font-size: 12px;">(ID: ${item.id})</span>`;
              li.dataset.id = item.id;
              li.dataset.name = item.name;

              // –°—Ç–∏–ª–∏ –¥–ª—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —Å–ø–∏—Å–∫–∞
              li.style.padding = "10px 12px";
              li.style.cursor = "pointer";
              li.style.borderBottom = "1px solid #eee";
              li.style.backgroundColor = "#fff";

              li.addEventListener("mouseenter", () => {
                li.style.backgroundColor = "#f8f9fa";
              });

              li.addEventListener("mouseleave", () => {
                li.style.backgroundColor = "#fff";
              });

              li.addEventListener("click", () => {
                nameInput.value = item.name;
                resultsContainer.hidden = true;
                nameInput.focus();
              });

              resultsContainer.appendChild(li);
            });

            resultsContainer.hidden = false;
          })
          .catch(error => {
            console.error("Autocomplete error:", error);
            resultsContainer.hidden = true;
          });
      }, 300);
    });

    // –°–∫—Ä—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
    document.addEventListener("click", (event) => {
      if (!nameInput.contains(event.target) && !resultsContainer.contains(event.target)) {
        resultsContainer.hidden = true;
      }
    });

    // –°–∫—Ä—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ Escape
    nameInput.addEventListener("keydown", (event) => {
      if (event.key === "Escape") {
        resultsContainer.hidden = true;
      }
    });

    // –§–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    nameInput.focus();
  </script>

  <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR-–∫–æ–¥–∞ -->
  {% if qr_base64 and not error_message %}
    <div style="
      margin-top: 30px;
      padding: 25px;
      border: 2px solid #28a745;
      border-radius: 10px;
      background-color: #f8fff9;
      text-align: center;
    ">
      <h3 style="color: #28a745; margin-top: 0;">
        üéâ QR-–∫–æ–¥ –≥–æ—Ç–æ–≤!
      </h3>

      <div style="margin: 15px 0;">
        <strong style="font-size: 18px;">{{ product_name }}</strong>
        <br>
        <span style="color: #666; font-size: 14px;">ID: {{ product_id }}</span>
      </div>

      <div style="margin: 25px 0;">
        <img src="data:image/png;base64,{{ qr_base64 }}"
             alt="QR Code –¥–ª—è {{ product_name }}"
             style="
               border: 1px solid #ddd;
               border-radius: 8px;
               padding: 10px;
               background: white;
             ">
      </div>

      <div style="margin-top: 20px; margin-bottom: 20px;">
        <p style="margin: 5px 0; font-weight: bold;">
          –°—Å—ã–ª–∫–∞ –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫—É —Ç–æ–≤–∞—Ä–∞:
        </p>
        <a href="{{ gen_url }}"
           target="_blank"
           style="
             color: #007bff;
             text-decoration: none;
             word-break: break-all;
             font-size: 14px;
             background: #f8f9fa;
             padding: 8px 12px;
             border-radius: 4px;
             display: inline-block;
             margin: 5px 0;
           ">
          {{ gen_url }}
        </a>
      </div>

      <div style="margin-top: 25px;">


        <button onclick="copyToClipboard('{{ gen_url }}')" style="
          padding: 10px 20px;
          background-color: #6c757d;
          color: white;
          border: none;
          border-radius: 5px;
          cursor: pointer;
          margin: 0 5px;
          font-size: 14px;
        ">
          üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É
        </button>


      </div>
    </div>

    <script>
      function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(function() {
          alert('‚úÖ –°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
        }, function(err) {
          console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è: ', err);
          // Fallback –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤
          const textArea = document.createElement("textarea");
          textArea.value = text;
          document.body.appendChild(textArea);
          textArea.select();
          try {
            document.execCommand('copy');
            alert('‚úÖ –°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
          } catch (err) {
            alert('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É');
          }
          document.body.removeChild(textArea);
        });
      }

      function downloadQR() {
        const qrImage = document.querySelector('img[alt*="QR Code"]');
        const link = document.createElement('a');
        link.download = 'QR-–∫–æ–¥-{{ product_name|slugify }}.png';
        link.href = qrImage.src;
        link.click();
      }
    </script>
  {% endif %}

{% endblock %}