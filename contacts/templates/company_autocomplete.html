
{% block company-autocomplete %}
  <div class="autocomplete-container">
    <label for="company_name">Название компании:</label>
    <input
      type="text"
      name="company_name"
      id="company_name"
      placeholder="Введите название компании"
      class="form-input">
    <input type="hidden" name="company_id" id="company_id">
    <ul id="autocomplete_results" class="autocomplete-results" hidden></ul>
  </div>

  <script>
    const nameInput = document.getElementById("company_name");
    const idInput = document.getElementById("company_id");
    const resultsContainer = document.getElementById("autocomplete_results");

    let timeoutId;

    nameInput.addEventListener("input", () => {
      clearTimeout(timeoutId);
      const query = nameInput.value.trim();

      if (query.length < 2) {
        resultsContainer.hidden = true;
        return;
      }

      timeoutId = setTimeout(() => {
        fetch(`/contacts/autocomplete?q=${encodeURIComponent(query)}`)
          .then(response => response.json())
          .then(data => {
            resultsContainer.innerHTML = "";
            if (data.results.length === 0) {
              resultsContainer.hidden = true;
              return;
            }

            data.results.forEach(item => {
              const li = document.createElement("li");
              li.textContent = item.title;
              li.dataset.id = item.id;
              li.classList.add("autocomplete-item");

              li.addEventListener("click", () => {
                nameInput.value = item.title;
                idInput.value = item.id;
                resultsContainer.hidden = true;
              });

              resultsContainer.appendChild(li);
            });

            resultsContainer.hidden = false;
          });
      }, 300);
    });

    // Закрытие выпадающего списка при клике вне его области
    document.addEventListener('click', (e) => {
      if (!resultsContainer.contains(e.target) && e.target !== nameInput) {
        resultsContainer.hidden = true;
      }
    });
  </script>

  <style>
    .autocomplete-container {
      position: relative;
      margin: 1.5rem 0;
    }
    
    .autocomplete-results {
      border: 1px solid #e1e5e9;
      border-radius: 4px;
      max-height: 200px;
      overflow-y: auto;
      padding: 0;
      margin: 0;
      width: 100%;
      position: absolute;
      background: white;
      list-style: none;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      z-index: 1000;
    }
    
    .autocomplete-item {
      padding: 0.75rem;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    .autocomplete-item:hover {
      background-color: #f5f7f9;
    }
  </style>
{% endblock %}
